# 2.4 – Mapping Source → Cible (RNE)

## 1. Objectif
Documenter comment les champs JSON fournis par le RNE sont transformés et injectés dans les tables SQLite de `rne.db` :

- `unite_legale`
- `siege`
- `etablissement`
- `activite`
- `immatriculation`
- `dirigeant_pp`
- `dirigeant_pm`

La présente section ne couvre que le mapping RNE → `rne.db` (pas l’enrichissement SIRENE).

---

## 2. Logique générale

1. **Parsing / validation JSON**
   - Les objets JSON RNE (stock et flux) sont validés via des modèles Pydantic.
   - Les champs sont typés (dates, booléens, chaînes, listes…).

2. **Normalisation**
   - Construction d’objets d’adresse puis formatage en texte (fonction de type `format_address`).
   - Agrégation de plusieurs champs pour la forme juridique (`get_forme_juridique`) ou les dates (`get_date_creation`, `get_detail_cessation`).
   - Construction de listes de natures d’entreprise (`get_nature_entreprise_list`), sérialisées ensuite en JSON.
   - Mise en forme des prénoms (liste → chaîne jointe par un espace).
   - Conversion des booléens en texte pour SQLite.

3. **Injection dans les tables SQLite**
   - Création d’une ligne par unité légale, siège, établissement, activité, dirigeant, enregistrement d’immatriculation.
   - Propagation systématique de :
     - `updatedAt` → `date_mise_a_jour`,
     - chemin du fichier JSON → `file_name`.
   - Suppression des doublons par SIREN / SIRET selon le type de table (avant insert).

---

## 3. Tables concernées

Les tables créées dans `rne.db` sont :

- `unite_legale` : identité légale et métadonnées globales par SIREN.
- `siege` : informations de siège (SIRET, enseigne, adresse).
- `etablissement` : liste des établissements secondaires.
- `activite` : activités déclarées au niveau du siège et des établissements.
- `immatriculation` : immatriculation, radiation, capital, nature d’entreprise.
- `dirigeant_pp` : dirigeants personnes physiques.
- `dirigeant_pm` : dirigeants personnes morales.

---

## 4. Mapping détaillé par table

### 4.1 `unite_legale`

**Colonnes principales**

- `siren`  
  - **Source JSON** : `siren`  
  - **Transformation** : copie directe depuis la racine du JSON.  
  - Sert de clé principale pour l’unité légale.

- `denomination`  
  - **Source JSON** : `identite.entreprise.denomination`  
  - **Transformation** : copie directe.

- `nom_commercial`  
  - **Source JSON** : `identite.entreprise.nomCommercial`  
  - **Transformation** : copie directe.

- `tranche_effectif_salarie`  
  - **Source JSON** : `identite.entreprise.effectifSalarie`  
  - **Transformation** : copie directe.

- `date_creation`  
  - **Sources JSON** : `createdAt`, `formality.content.natureCreation.dateCreation`  
  - **Transformation** : fonction de type `get_date_creation` qui prend en priorité `createdAt`, puis la date de création déclarée si disponible.  
  - **Format** : texte / date ISO telle que fournie.

- `nature_juridique`  
  - **Sources JSON** :  
    - `formality.formeJuridique`  
    - `formality.content.natureCreation.formeJuridique`  
    - `identite.entreprise.formeJuridique` / `identite.entreprise.formeJuridiqueInsee`  
  - **Transformation** : fonction de type `get_forme_juridique` qui priorise la forme juridique issue de la formalité, puis la nature de création, puis l’identité entreprise.  
  - **Format** : texte.

- `forme_exercice_activite_principale`  
  - **Source JSON** : `formality.content.formeExerciceActivitePrincipale`  
  - **Transformation** : copie directe.

- `etat_administratif`  
  - **Source JSON** : `formality.content.natureCessationEntreprise.etatAdministratifInsee`  
  - **Transformation** : copie directe.

- `statut_diffusion`  
  - **Source JSON** : `formality.diffusionINSEE`  
  - **Transformation** : copie directe.

- `adresse`  
  - **Source JSON** : `adresseEntreprise.adresse.{pays, codePays, commune, codePostal, codeInseeCommune, voie, numVoie, typeVoie, indiceRepetition, complementLocalisation, distributionSpeciale}`  
  - **Transformation** :  
    - création d’un objet d’adresse structuré ;  
    - formatage en une chaîne unique via une fonction de type `format_address`.  
  - **Format** : texte concaténé.

- `date_mise_a_jour`  
  - **Source JSON** : `updatedAt`  
  - **Transformation** : copie directe, utilisée comme date de mise à jour RNE.

- `file_name`  
  - **Source JSON** : chemin du fichier JSON lu  
  - **Transformation** : copie directe.

**Autres comportements**

- Certaines informations sur les dirigeants (issues de `composition` ou `identite.entrepreneur`) sont re-projetées dans `dirigeant_pp` / `dirigeant_pm` (voir sections 4.6 et 4.7), et éventuellement recopiées pour disposer d’un triplet nom / prénom au niveau UL dans d’autres parties du pipeline.

---

### 4.2 `siege`

**Colonnes principales**

- `siren`  
  - **Source JSON** : `siren`  
  - **Transformation** : copie directe.

- `siret`  
  - **Source JSON** : `etablissementPrincipal.descriptionEtablissement.siret`  
  - **Transformation** : copie directe.

- `nom_commercial`, `enseigne`  
  - **Source JSON** : `etablissementPrincipal.descriptionEtablissement.{nomCommercial, enseigne}`  
  - **Transformation** : copie directe.

- Colonnes d’adresse (`pays`, `code_pays`, `commune`, `code_postal`, `code_commune`, `voie`, `num_voie`, `type_voie`, `indice_repetition`, `complement_localisation`, `distribution_speciale`)  
  - **Source JSON** : `etablissementPrincipal.adresse.{...}`  
  - **Transformation** : mapping champ à champ, sans concaténation (chaque composante est stockée dans une colonne dédiée).

- `date_mise_a_jour`  
  - **Source JSON** : `updatedAt`  
  - **Transformation** : copie directe.

- `file_name`  
  - **Source JSON** : chemin du fichier JSON  
  - **Transformation** : copie directe.

---

### 4.3 `etablissement`

**Colonnes principales**

- `siren`  
  - **Source JSON** : `siren`  
  - **Transformation** : copie directe.

- `siret`  
  - **Source JSON** : `autresEtablissements[].descriptionEtablissement.siret`  
  - **Transformation** : copie directe, une ligne par établissement secondaire.

- `date_mise_a_jour`  
  - **Source JSON** : `updatedAt`  
  - **Transformation** : copie directe.

- `file_name`  
  - **Source JSON** : chemin du fichier JSON  
  - **Transformation** : copie directe.

**Remarque**

- Les adresses des établissements secondaires (`autresEtablissements[].adresse.*`) sont **ignorées** dans `rne.db` (non mappées dans cette table).

---

### 4.4 `activite`

**Colonnes principales**

Les activités sont créées :

- pour l’établissement principal (`etablissementPrincipal.activites[]`) ;  
- pour chaque établissement secondaire (`autresEtablissements[].activites[]`).

Pour chaque activité :

- `siren`  
  - **Source JSON** : `siren`  
  - **Transformation** : copie directe.

- `siret`  
  - **Source JSON** :  
    - `etablissementPrincipal.descriptionEtablissement.siret` pour les activités du siège ;  
    - `autresEtablissements[].descriptionEtablissement.siret` pour les autres.  
  - **Transformation** : copie directe.

- `code_category`  
  - **Source JSON** : `activites[].categoryCode`  
  - **Transformation** : copie directe.

- `code_ape`  
  - **Source JSON** : `activites[].codeApe`  
  - **Transformation** : copie directe.

- `indicateur_principal`, `indicateur_prolongement`  
  - **Source JSON** : `activites[].indicateurPrincipal`, `activites[].indicateurProlongement`  
  - **Transformation** : copie directe, booléens sérialisés en type SQLite (stockés comme BOOL/TEXT selon la création de table).

- `indicateur_activitee_ape`, `activite_rattachee_eirl`  
  - **Source JSON** : `activites[].indicateurActiviteeApe`, `activites[].activiteRattacheeEirl`  
  - **Transformation** : copie directe (booléens).

- `date_debut`  
  - **Source JSON** : `activites[].dateDebut`  
  - **Transformation** : copie directe.

- `form_exercice`  
  - **Source JSON** : `activites[].formeExercice`  
  - **Transformation** : copie directe.

- `categorisation_activite1`, `categorisation_activite2`, `categorisation_activite3`  
  - **Source JSON** : `activites[].categorisationActivite1/2/3`  
  - **Transformation** : copie directe.

- `date_mise_a_jour`  
  - **Source JSON** : `updatedAt`  
  - **Transformation** : copie directe.

- `file_name`  
  - **Source JSON** : chemin du fichier  
  - **Transformation** : copie directe.

---

### 4.5 `immatriculation`

**Colonnes principales**

- `siren`  
  - **Source JSON** : `siren`  
  - **Transformation** : copie directe.

- `date_mise_a_jour`  
  - **Source JSON** : `updatedAt`  
  - **Transformation** : copie directe.

- `date_immatriculation`  
  - **Source JSON** : `identite.entreprise.dateImmat`  
  - **Transformation** : copie directe.

- `date_radiation`  
  - **Source JSON** : `detailCessationEntreprise.{dateRadiation, dateEffet, dateCessationTotaleActivite}`  
  - **Transformation** : fonction de type `get_detail_cessation` qui prend la **première date non nulle**, avec priorité à la radiation, puis date d’effet, puis cessation totale.

- `date_debut_activite`  
  - **Source JSON** : `identite.entreprise.dateDebutActiv`  
  - **Transformation** : copie directe.

- `indicateur_associe_unique`  
  - **Source JSON** : `identite.entreprise.indicateurAssocieUnique`  
  - **Transformation** : copie directe, booléen sérialisé en texte.

- `capital_social`  
  - **Source JSON** : `identite.description.montantCapital`  
  - **Transformation** : copie directe.

- `capital_variable`  
  - **Source JSON** : `identite.description.capitalVariable`  
  - **Transformation** : booléen sérialisé (stocké en TEXT).

- `devise_capital`  
  - **Source JSON** : `identite.description.deviseCapital`  
  - **Transformation** : copie directe.

- `date_cloture_exercice`  
  - **Source JSON** : `identite.description.dateClotureExerciceSocial`  
  - **Transformation** : copie directe.

- `duree_personne_morale`  
  - **Source JSON** : `identite.description.duree`  
  - **Transformation** : copie directe (entier).

- `nature_entreprise`  
  - **Source JSON** : dérivée de plusieurs sources d’activités (forme d’exercice, indicateurs principaux)  
  - **Transformation** :  
    - construction d’un set de natures via `get_nature_entreprise_list` (forme d’exercice principale + activités marquées comme principales) ;  
    - sérialisation en chaîne JSON (`json.dumps`).  

- `file_name`  
  - **Source JSON** : chemin du fichier JSON  
  - **Transformation** : copie directe.

---

### 4.6 `dirigeant_pp`

**Dirigeants personnes physiques (PP)**

- **Source principale** : `composition.pouvoirs[]` avec `typeDePersonne == "INDIVIDU"`.

**Colonnes principales**

- `siren`  
  - **Source JSON** : `siren`  
  - **Transformation** : copie directe.

- `nom`, `nom_usage`, `prenoms`, `genre`  
  - **Source JSON** : `composition.pouvoirs[].individu.descriptionPersonne.{nom, nomUsage, prenoms[], genre}`  
  - **Transformation** :  
    - `nom`, `nom_usage`, `genre` : copie directe ;  
    - `prenoms` : liste jointe par un espace (concaténation).

- `date_de_naissance`  
  - **Source JSON** : `composition.pouvoirs[].individu.descriptionPersonne.dateDeNaissance`  
  - **Transformation** : copie directe (texte).

- `nationalite`, `situation_matrimoniale`  
  - **Source JSON** : `composition.pouvoirs[].individu.descriptionPersonne.{nationalite, situationMatrimoniale}`  
  - **Transformation** : copie directe.

- `role`  
  - **Source JSON** : `composition.pouvoirs[].roleEntreprise`  
  - **Transformation** : copie directe (code rôle).

- `date_mise_a_jour`  
  - **Source JSON** : `updatedAt`  
  - **Transformation** : copie directe.

- `file_name`  
  - **Source JSON** : chemin du fichier JSON  
  - **Transformation** : copie directe.

**Cas particulier : entrepreneur individuel**

- Quand il n’y a pas de bloc `composition.pouvoirs`, l’entrepreneur individuel est dérivé de `identite.entrepreneur.descriptionPersonne` et injecté comme une ligne `dirigeant_pp` avec les mêmes colonnes identitaires, mais sans rôle renseigné.

---

### 4.7 `dirigeant_pm`

**Dirigeants personnes morales (PM)**

- **Source principale** : `composition.pouvoirs[]` avec `typeDePersonne == "ENTREPRISE"`.

**Colonnes principales**

- `siren`  
  - **Source JSON** : `siren`  
  - **Transformation** : copie directe.

- `siren_dirigeant`  
  - **Source JSON** : `composition.pouvoirs[].entreprise.siren`  
  - **Transformation** : nettoyage de la valeur (suppression des espaces) puis copie.

- `denomination`  
  - **Source JSON** : `composition.pouvoirs[].entreprise.denomination`  
  - **Transformation** : copie directe.

- `role`  
  - **Source JSON** : `composition.pouvoirs[].roleEntreprise`  
  - **Transformation** : copie directe (code rôle).

- `pays`  
  - **Source JSON** : `composition.pouvoirs[].entreprise.pays`  
  - **Transformation** : copie directe.

- `forme_juridique`  
  - **Source JSON** : `composition.pouvoirs[].entreprise.formeJuridique`  
  - **Transformation** : copie directe.

- `date_mise_a_jour`  
  - **Source JSON** : `updatedAt`  
  - **Transformation** : copie directe.

- `file_name`  
  - **Source JSON** : chemin du fichier JSON  
  - **Transformation** : copie directe.

---

## 5. Points d’attention

- **Champs JSON non utilisés**  
  Plusieurs champs présents dans le JSON RNE ne sont pas mappés vers `rne.db`, par exemple :
  - `origin`  
  - `formality.companyName`, `formality.typePersonne`, `formality.codeAPE`  
  - `content.natureCreation.formeJuridiqueInsee`, `societeEtrangere`, `entrepriseAgricole`  
  - `identite.entreprise.codeApe`  
  - `identite.entrepreneur.adresseDomicile.*`  
  - `composition.pouvoirs[].libelleRoleEntreprise`, `composition.pouvoirs[].adresseEntreprise.*`  
  - certains champs de détails d’adresse ou d’identifiant étranger des dirigeants PM.

- **Booléens sérialisés**  
  Les champs booléens (ex : `indicateurAssocieUnique`, `capitalVariable`, `indicateurActiviteeApe`, `activiteRattacheeEirl`) sont stockés en SQLite comme TEXT ou BOOL selon la définition de table, ce qui peut nécessiter une reconversion côté consommateur.

- **Prénoms aplatis**  
  La liste `prenoms[]` des personnes physiques est aplatie en une seule chaîne (`"PRENOM1 PRENOM2"`). La granularité par prénom individuel est perdue dans `rne.db`.

- **Adresse des dirigeants et établissements secondaires**  
  - Les adresses personnelles des dirigeants (`adresseDomicile`) ne sont pas stockées.  
  - Les adresses des établissements secondaires ne sont pas recopiées dans `etablissement` ou `activite` (seuls les SIRET sont présents).

- **Nature d’entreprise multi-sources**  
  - Le champ `nature_entreprise` dépend de plusieurs sources (formes d’exercice des activités marquées principales).  
  - Il peut rester vide si aucune activité n’est taguée comme principale ou si les informations sont incomplètes.

- **Traçabilité**  
  - Chaque ligne de `rne.db` conserve la provenance du JSON (`file_name`) et la date de mise à jour (`date_mise_a_jour`), ce qui permet de remonter au fichier d’origine en cas de doute ou d’anomalie.
