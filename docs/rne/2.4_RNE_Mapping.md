# 2.4 – Mapping Source → Cible (RNE)

## 1. Objectif
Documenter comment les champs JSON fournis par le RNE sont transformés et injectés dans les tables SQLite de `rne.db`.

Ce document couvre exclusivement le mapping RNE → `rne.db`.

---

## 2. Logique générale

1. **Parsing / validation JSON**
   - Validation via modèles Pydantic.
   - Typage des champs (dates, booléens, chaînes, listes…).

2. **Normalisation**
   - Formatage d’adresse (UL) via une fonction type `format_address` utilisant uniquement certains champs disponibles.
   - Priorisation définie pour :  
     - `date_creation` (createdAt puis natureCreation.dateCreation)  
     - `nature_juridique` (formeJuridique puis natureCreation puis identite.*)  
     - `date_radiation` (dateRadiation puis dateEffet puis dateCessationTotaleActivite)
   - Concaténation des prénoms pour les dirigeants PP.
   - Agrégation multi-sources pour `nature_entreprise`, sérialisée en JSON.

3. **Injection dans SQLite**
   - Une ligne par unité légale, siège, établissement, activité, dirigeant et immatriculation.
   - `date_mise_a_jour` = `updatedAt`.
   - `file_name` = chemin du JSON source.
   - **Déduplication uniquement par SIREN** dans toutes les tables (pas de déduplication par SIRET).

---

## 3. Tables concernées
- `unite_legale`
- `siege`
- `etablissement`
- `activite`
- `immatriculation`
- `dirigeant_pp`
- `dirigeant_pm`

---

## 4. Mapping détaillé par table

### 4.1 unite_legale

**Colonnes principales**

- `siren` ← `siren`
- `denomination` ← `identite.entreprise.denomination`
- `nom_commercial` ← `identite.entreprise.nomCommercial`
- `tranche_effectif_salarie` ← `identite.entreprise.effectifSalarie`
- `date_creation` ← priorité :  
  1. `createdAt`  
  2. `formality.content.natureCreation.dateCreation`
- `nature_juridique` ← priorité :  
  1. `formality.formeJuridique`  
  2. `formality.content.natureCreation.formeJuridique`  
  3. `identite.entreprise.formeJuridique` / `formeJuridiqueInsee`
- `forme_exercice_activite_principale` ← `formality.content.formeExerciceActivitePrincipale`
- `etat_administratif` ← `formality.content.natureCessationEntreprise.etatAdministratifInsee`
- `statut_diffusion` ← `formality.diffusionINSEE`
- `adresse`  
  - construite via `format_address`  
  - **uniquement à partir des champs effectivement utilisés dans le code** :  
    `{complementLocalisation, numVoie, indiceRepetition, typeVoie, voie, commune, distributionSpeciale, codePostal}`  
  - concaténés sous forme d’une chaîne unique.
- `date_mise_a_jour` ← `updatedAt`
- `file_name` ← chemin du JSON

**Champs UL supplémentaires (personnes physiques)**  
Lorsque l’UL correspond à une personne physique, trois colonnes sont également renseignées à partir du **premier dirigeant personne physique** (ou de l’entrepreneur individuel) :

- `nom`
- `nom_usage`
- `prenom` (concaténation des prénoms JSON)

**Colonne non alimentée**  
- `activite_principale` : la colonne existe dans la table mais **n’est jamais renseignée** (toujours NULL).

---

### 4.2 siege

**Colonnes principales**

- `siren` ← `siren`
- `siret` ← `etablissementPrincipal.descriptionEtablissement.siret`
- `nom_commercial` ← `etablissementPrincipal.descriptionEtablissement.nomCommercial`
- `enseigne` ← `etablissementPrincipal.descriptionEtablissement.enseigne`

**Colonnes d’adresse**

Les valeurs proviennent de :

- `etablissementPrincipal.adresse.voie`
  (Codex souligne qu’il ne s’agit pas d’un mapping champ-à-champ complet)

Autres colonnes d’adresse mappées :
- `pays`, `code_pays`, `num_voie`, `type_voie`, `commune`, `code_postal`, `indice_repetition`, `complement_localisation`, `distribution_speciale`

**Colonne non alimentée**
- `code_commune` : **toujours NULL** dans le mapping actuel.

**Métadonnées**

- `date_mise_a_jour` ← `updatedAt`
- `file_name` ← chemin du JSON

---

### 4.3 etablissement

- `siren` ← `siren`
- `siret` ← `autresEtablissements[].descriptionEtablissement.siret`
- `date_mise_a_jour` ← `updatedAt`
- `file_name` ← chemin du JSON
- **Adresse ignorée** : les champs `autresEtablissements[].adresse.*` ne sont pas injectés.

---

### 4.4 activite

Insérées pour :
- les activités du siège
- les activités des établissements secondaires

**Champs mappés**

- `siren`
- `siret` (selon siège ou établissement secondaire)
- `code_category` ← `categoryCode`
- `code_ape` ← `codeApe`
- `indicateur_principal` ← `indicateurPrincipal`
- `indicateur_prolongement` ← `indicateurProlongement`
- `indicateur_activitee_ape` ← `indicateurActiviteeApe`
- `activite_rattachee_eirl` ← `activiteRattacheeEirl`
- `date_debut` ← `dateDebut`
- `form_exercice` ← `formeExercice`
- `categorisation_activite1/2/3`
- `date_mise_a_jour` ← `updatedAt`
- `file_name`

**Adresse ignorée** (comme pour les établissements).

---

### 4.5 immatriculation

- `siren`
- `date_mise_a_jour`
- `date_immatriculation` ← `identite.entreprise.dateImmat`
- `date_radiation` ← priorité :  
  1. `detailCessationEntreprise.dateRadiation`  
  2. `detailCessationEntreprise.dateEffet`  
  3. `detailCessationEntreprise.dateCessationTotaleActivite`
- `date_debut_activite` ← `identite.entreprise.dateDebutActiv`
- `indicateur_associe_unique` ← `identite.entreprise.indicateurAssocieUnique`
- `capital_social` ← `identite.description.montantCapital`
- `capital_variable` ← `identite.description.capitalVariable`
- `devise_capital` ← `identite.description.deviseCapital`
- `date_cloture_exercice` ← `identite.description.dateClotureExerciceSocial`
- `duree_personne_morale` ← `identite.description.duree`
- `nature_entreprise` ← sérialisation JSON du set produit par :  
  - `formeExerciceActivitePrincipale`  
  - + `formeExercice` des activités **marquées indicateurPrincipal** (tous établissements)
- `file_name`

---

### 4.6 dirigeant_pp

- `siren`
- `nom`, `nom_usage`, `prenoms`, `genre` ← `composition.pouvoirs[].individu.descriptionPersonne.*`
- `prenoms` concaténés par un espace
- `date_de_naissance`
- `nationalite`
- `situation_matrimoniale`
- `role` ← `roleEntreprise`
- `date_mise_a_jour` ← `updatedAt`
- `file_name`

**Cas particulier : entrepreneur individuel**  
Même mapping que PP (nom / prenom / nom_usage / genre / date_naissance…), mais sans rôle.

---

### 4.7 dirigeant_pm

- `siren`
- `siren_dirigeant` ← `composition.pouvoirs[].entreprise.siren`  
  (après nettoyage **suppression espaces**)
- `denomination`
- `role`
- `pays`
- `forme_juridique`
- `date_mise_a_jour` ← `updatedAt`
- `file_name`

---

## 5. Points d’attention

- Plusieurs champs du JSON RNE sont présents mais jamais utilisés (origin, codeAPE interne, adresses personnelles des dirigeants, libelleRoleEntreprise, etc.).
- Les booléens (`capitalVariable`, `indicateurActiviteeApe`, etc.) sont stockés tels quels dans SQLite (TEXT/BOOLEAN selon définition).
- `prenoms[]` est aplati → perte de granularité.
- Les adresses des dirigeants et établissements secondaires ne sont pas reprises.
- `activite_principale` en UL existe mais reste systématiquement NULL.
- `code_commune` en siège existe mais n’est jamais alimenté.
- Déduplication effectuée **uniquement par SIREN** dans toutes les tables.

