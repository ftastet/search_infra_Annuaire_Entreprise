# 2.6 – Consommation de la base RNE par l’entreprise

## 1. Objectif
Expliquer comment exploiter le snapshot consolidé `rne_<date>.db.gz` généré quotidiennement par le pipeline RNE, et comment l’intégrer dans un SI interne.

---

## 2. Récupération de l’artefact

### 2.1 Depuis MinIO
Le pipeline publie à chaque exécution :
- un snapshot consolidé compressé : `rne/database/rne_<date>.db.gz`
- un pointeur d’avancement : `rne/database/latest_rne_date.json`

Étapes pour consommer la base :
1. Télécharger `rne_<date>.db.gz`
2. Décompresser : `gunzip rne_<date>.db.gz`
3. Ouvrir `rne_<date>.db` (SQLite) avec un outil interne ou un script Python.
   - le fichier correspond au dernier flux **consolidé** (le flux le plus récent téléchargé n’est pas intégré).

### 2.2 Process interne automatisé
Une automatisation interne peut :
- récupérer quotidiennement le snapshot via un DAG Airflow,
- utiliser un cron + `mc` (MinIO client),
- ou s’appuyer sur un module d’ingestion interne existant.

### 2.3 Fréquence recommandée
- **Quotidienne** pour un référentiel légal ou des contrôles de conformité.
- **Hebdomadaire** pour une intégration dans un datawarehouse.
- **À la demande** pour un audit ponctuel.

---

## 3. Cas d’usage principaux

### 3.1 Référentiel entreprise
Le snapshot RNE peut servir de base interne :
- forme juridique,
- état administratif,
- dirigeants PP/PM,
- dates clés (création, radiation),
- activités APE.

### 3.2 Analyse des dirigeants
Les tables `dirigeant_pp` et `dirigeant_pm` permettent :
- l’identification des dirigeants,
- l’analyse des rôles,
- la reconstruction d’une chaîne de contrôle.

### 3.3 Fiches RNE internes
Le snapshot peut être utilisé pour :
- générer des fiches entreprises,
- compléter des écrans internes,
- alimenter un front interne de consultation.

### 3.4 Moteur de recherche interne
Requêtage optimisé via indexation interne :
- SIREN,
- SIRET du siège,
- dirigeants,
- code APE,
- commune et voie du siège.

### 3.5 Audit conformité / obligations légales
Exemples :
- suivi de radiation,
- contrôle de cohérence juridique,
- identification des entreprises actives / inactives.

### 3.6 Rapprochements internes
Jointures possibles avec :
- SIRENE,
- référentiels clients,
- CRM,
- SI métiers.

---

## 4. Intégration recommandée

### 4.1 Ingestion SQL
Méthode classique :
1. Décompression du fichier `.gz`
2. Lecture des tables SQLite
3. Import vers :
   - PostgreSQL,
   - DuckDB,
   - BigQuery,
   - Snowflake,
   - Datawarehouse interne.

### 4.2 Extraction CSV
Depuis SQLite :
- `sqlite3 rne_<date>.db "SELECT * FROM unite_legale" > unite_legale.csv`

Utilisation :
- outils BI,
- audits ponctuels,
- analyse exploratoire.

### 4.3 Automatisation
Process interne recommandé :
- récupération du dernier snapshot,
- ingestion SQL,
- purge interne des anciens fichiers,
- génération de rapports ou dashboards.

### 4.4 Intégration Data Lake / Data Warehouse
Structure recommandée :
- **Bronze** : snapshot brut SQLite
- **Silver** : tables nettoyées / typées dans le DWH
- **Gold** : vues métiers (référentiel entreprise, dirigeants, etc.)

---

## 5. Points d’attention

### 5.1 Versionning quotidien
Le pipeline conserve :
- un snapshot `rne_<date>.db.gz` par jour (historisation),
- un pointeur mis à jour (`latest_rne_date.json`).

### 5.2 Modèle évolutif
Le schéma RNE peut évoluer :
- nouvelles colonnes INPI,
- ajustements du mapping,
- modifications dans les flux.

### 5.3 Flux J0
Le pipeline n’intègre jamais le flux du jour J :
- uniquement stock + flux jusqu’au dernier flux consolidé (le flux le plus récent téléchargé est exclu, ce qui décale d’au moins un jour la date de couverture effective).

### 5.4 Champs absents
Les données suivantes ne sont **pas injectées dans la base consolidée** :
- emails,
- téléphones,
- adresses des établissements secondaires.

### 5.5 Colonnes NULL connues
Certaines colonnes existent dans la base mais sont :
- `activite_principale` → jamais renseignée,
- `code_commune` (siège) → jamais alimentée.

### 5.6 Cohérence interne
Recommandations pour les consommateurs :
- vérifier l’unicité SIREN,
- contrôler les dates clés,
- tester les jointures avant intégration massive.

---

## 6. Résumé
- `rne_<date>.db.gz` est un snapshot consolidé complet du RNE (stock + flux cumulés jusqu’à l’avant-dernier flux téléchargé).
- Il peut être intégré dans n’importe quel SI (SQL, DWH, datalake, moteur de recherche).
- Il répond aux besoins : référentiel entreprise, audit, conformité, recherche interne.
- L’intégration peut être automatisée via scripts ou Airflow.
- Certains champs RNE sont absents (contact, code commune…).

