# 2.3 – Construction quotidienne de la base RNE consolidée

## 1. Objectif
Expliquer comment la base consolidée RNE (SQLite) est créée et versionnée.

## 2. Input utilisés
- Stock RNE (optionnel après première exécution)
- Flux RNE depuis MinIO
- `latest_rne_date.json` (téléchargé depuis `rne/database/latest_rne_date.json` si présent, sinon start_date reste `None`)

## 3. Vue d’ensemble du DAG `fill_rne_database`
- Nettoyage initial
- Lecture de la dernière date : récupération de `latest_rne_date.json` depuis MinIO ; si trouvé, la clé `latest_date` est poussée en XCom (`start_date`), sinon la valeur `None` est poussée (aucun fallback `RNE_DEFAULT_START_DATE` dans ce DAG)
- Chargement du stock (si nécessaire) : exécuté uniquement quand `start_date` est `None`; tous les JSON du stock sont injectés puis supprimés localement
- Chargement des flux utiles : liste des flux MinIO, exclusion systématique du flux le plus récent (`json_daily_flux_files[:-1]`), filtrage par date (`file_date >= start_date` avec valeur par défaut "0000-00-00" pour la première exécution)
- Consolidation / Parsing
- Déduplication
- Validation
- Export SQLite + gzip : le fichier local `rne_<start_date>.db` est compressé en `rne_<start_date>.db.gz` puis uploadé dans MinIO sous le nom `rne_<last_date_processed>.db.gz`
- Mise à jour des métadonnées : `latest_rne_date.json` est réécrit avec `latest_date = last_date_processed + 1 jour`, uploadé vers `rne/database/`, puis supprimé localement
- Nettoyage final

## 4. Artefacts générés
- `rne_<date>.db.gz`
- `latest_rne_date.json`

## 5. Règles de versionning
- Nom basé sur dernier flux appliqué
- Gestion du flux J0
- Conservation sur MinIO

## 6. Points critiques
- Qualité des JSON
- Volume (stock vs flux)
- Cohérence date / index
