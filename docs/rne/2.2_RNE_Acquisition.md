# 2.2 – Acquisition des données RNE (stock + flux)

## 1. Objectif
Décrire comment les données sources RNE sont récupérées depuis l’INPI avant leur consolidation dans la base quotidienne.

---

## 2. Sources externes

### 2.1 Stock annuel
- Ressource fournie sous forme d’**archive ZIP** contenant des fichiers **JSON**.  
- Téléchargement réalisé via le script **`get_stock.sh`**, exécuté par le DAG `get_rne_stock`.  
- Extraction locale puis dépôt dans MinIO sous `rne/stock/`.

### 2.2 Flux quotidiens
- Données issues de l’API **RNE Diff** (endpoint companies/diff).  
- Le DAG télécharge **tous les flux manquants** entre la dernière date disponible en MinIO et la date courante.  
- Les flux sont enregistrés et envoyés vers MinIO sous forme de fichiers **compressés `.json.gz`**.

---

## 3. Stockage intermédiaire MinIO
- `rne/stock/` : fichiers JSON du stock annuel.  
- `rne/flux/` : fichiers de flux quotidiens au format **`.json.gz`**.

> L’acquisition ne génère **jamais** le répertoire `rne/database/` : celui-ci est produit exclusivement par le DAG `fill_rne_database`.

---

## 4. Orchestration

### 4.1 DAG `get_rne_stock`
- **Rôle** : télécharger, extraire et déposer le stock annuel.  
- **Déclenchement** : manuel (pas de cron).  
- **Étapes principales** :
  1. Préparation / nettoyage du dossier temporaire.  
  2. Téléchargement via `get_stock.sh`.  
  3. Extraction du ZIP.  
  4. Upload dans `rne/stock/`.

### 4.2 DAG `get_flux_rne`
- **Rôle** : récupérer les flux RNE manquants.  
- **Planning** : `0 1 * * *` (tous les jours à 01h00).  
- **Étapes principales** :
  1. Préparation / nettoyage du dossier temporaire.  
  2. Appel API RNE Diff.  
  3. Détermination du point de reprise via les fichiers `rne_flux_YYYY-MM-DD.json.gz` déjà présents dans MinIO  
     → sinon fallback sur `RNE_DEFAULT_START_DATE` (2025-04-03).  
  4. Téléchargement des flux manquants.  
  5. Enregistrement local puis upload vers MinIO au format **`.json.gz`**  
     (upload possible même en cas d’erreur avant suppression locale).  
  6. Nettoyage.

---

## 5. Points d’attention
- Le flux du **jour J** peut être incomplet → il est **systématiquement ignoré** lors de la consolidation.  
- Le point de reprise est déterminé **à partir des fichiers présents dans MinIO**, pas via `latest_rne_date.json`.  
- Lors de la première exécution, absence de flux → fallback sur `RNE_DEFAULT_START_DATE` (2025-04-03).  
- Les flux sont toujours stockés en **`.json.gz`**.  
- Un upload partiel peut se produire en cas d’erreur intermédiaire.
