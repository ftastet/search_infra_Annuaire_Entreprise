# 2.2 – Acquisition des données RNE (stock + flux)

## 1. Objectif
Décrire comment les données sources RNE sont récupérées depuis l’INPI avant leur consolidation dans la base quotidienne.

---

## 2. Sources externes

### 2.1 Stock annuel
- Ressource fournie sous forme d’**archive ZIP** contenant des fichiers **JSON**.  
- Téléchargement réalisé via le script **`get_stock.sh`**, exécuté par le DAG `get_rne_stock`.  
- Extraction locale puis dépôt dans MinIO sous `rne/stock/`.

### 2.2 Flux quotidiens
- Données issues de l’API **RNE Diff** (endpoint companies/diff).  
- Le DAG télécharge **tous les flux manquants** entre la dernière date traitée et la date courante, pas uniquement le flux du jour.  
- Les flux sont fournis sous forme de **JSON** et déposés dans `rne/flux/`.

---

## 3. Stockage intermédiaire MinIO
- `rne/stock/` : JSON du stock annuel.  
- `rne/flux/` : JSON des flux RNE quotidiens.  

> L’acquisition ne génère **jamais** le répertoire `rne/database/` : celui-ci est produit exclusivement par le DAG `fill_rne_database`.

---

## 4. Orchestration

### 4.1 DAG `get_rne_stock`
- **Rôle** : télécharger, extraire et déposer le stock annuel.  
- **Déclenchement** : manuel (pas de cron).  
- **Étapes principales** :
  1. Préparation / nettoyage du dossier temporaire.  
  2. Téléchargement via `get_stock.sh`.  
  3. Extraction du ZIP.  
  4. Upload dans `rne/stock/`.

### 4.2 DAG `get_flux_rne`
- **Rôle** : récupérer les flux RNE manquants.  
- **Planning** : `0 1 * * *` (tous les jours à 01h00).  
- **Étapes principales** :
  1. Préparation / nettoyage du dossier temporaire.  
  2. Appel API RNE Diff.  
  3. Récupération des flux **du jour et des jours manquants**.  
  4. Enregistrement sous forme de JSON.  
  5. Upload dans `rne/flux/`.  
  6. Nettoyage.

---

## 5. Points d’attention
- Le flux du **jour J** peut être incomplet → il est **systématiquement ignoré** lors de la consolidation.  
- La reprise dépend du fichier **`latest_rne_date.json`**, qui définit la date à partir de laquelle télécharger les flux.  
- Lors de la première exécution, absence de ce fichier → fallback sur `RNE_DEFAULT_START_DATE` (2025-04-03).  
- L’API peut renvoyer plusieurs jours en une fois (flux manquants).  
- Toute indisponibilité de l’API décale la consolidation au run suivant.
